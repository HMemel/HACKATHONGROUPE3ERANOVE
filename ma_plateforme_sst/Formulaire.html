<!DOCTYPE html>
<html lang="en">
<head>
    <title>MA PLATEFORME SST</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Portail - Bootstrap 5 Admin Dashboard Template For Developers">
    <meta name="author" content="Xiaoying Riley at 3rd Wave Media">
    <link rel="shortcut icon" href="logosst.ico">

    <!-- FontAwesome JS-->
    <script defer src="assets/plugins/fontawesome/js/all.min.js"></script>

    <!-- App CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/portal.css">

    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Include jQuery UI -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <!-- Include Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9pIGZnYSVzbVzbZA6L0rCO+FjkMlI5fQApD6yIU6Q9dmjfwE8KEFHltmiTkQ+x0" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function () {
            // Initialiser le datepicker
            $('#datepicker').datepicker({
                format: 'dd/mm/yyyy',
                startDate: '-infinity',
                endDate: 'today'
            });

            // Charger les options des listes déroulantes via AJAX
            $.ajax({
                url: 'http://217.76.50.150:3000/api/departement/get',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    var departements = data.items;
                    var departementSelect = $('#departementSelect');
                    departementSelect.empty();
                    $.each(departements, function (index, departement) {
                        departementSelect.append('<option value="' + departement.idDepartement + '">' + departement.libelle + '</option>');
                    });
                },
                error: function (error) {
                    console.log('Erreur:', error);
                }
            });

            $.ajax({
                url: 'http://217.76.50.150:3000/api/site/get',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    var sites = data.items;
                    var siteSelect = $('#siteSelect');
                    siteSelect.empty();
                    $.each(sites, function (index, site) {
                        siteSelect.append('<option value="' + site.idSite + '">' + site.libelle + '</option>');
                    });
                },
                error: function (error) {
                    console.log('Erreur:', error);
                }
            });

            $.ajax({
                url: 'http://217.76.50.150:3000/api/employe/get',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    var employes = data.items;
                    var employeSelect = $('#employeSelect');
                    employeSelect.empty();
                    $.each(employes, function (index, employe) {
                        employeSelect.append('<option value="' + employe.idEmploye + '">' + employe.matricule + " " + employe.nom + " " + employe.prenoms + '</option>');
                    });
                },
                error: function (error) {
                    console.log('Erreur:', error);
                }
            });

			  // Fonction pour récupérer les informations du navigateur
			  function getBrowserInfo() {
        var userAgent = navigator.userAgent;
        var browserName = navigator.appName;
        var browserVersion = '' + parseFloat(navigator.appVersion);
        var majorVersion = parseInt(navigator.appVersion, 10);
        var nameOffset, verOffset, ix;

        // In Opera, the true version is after "Opera" or after "Version"
        if ((verOffset = userAgent.indexOf("Opera")) != -1) {
            browserName = "Opera";
            browserVersion = userAgent.substring(verOffset + 6);
            if ((verOffset = userAgent.indexOf("Version")) != -1)
                browserVersion = userAgent.substring(verOffset + 8);
        }
        // In MSIE, the true version is after "MSIE" in userAgent
        else if ((verOffset = userAgent.indexOf("MSIE")) != -1) {
            browserName = "Microsoft Internet Explorer";
            browserVersion = userAgent.substring(verOffset + 5);
        }
        // In Chrome, the true version is after "Chrome" 
        else if ((verOffset = userAgent.indexOf("Chrome")) != -1) {
            browserName = "Chrome";
            browserVersion = userAgent.substring(verOffset + 7);
        }
        // In Safari, the true version is after "Safari" or after "Version" 
        else if ((verOffset = userAgent.indexOf("Safari")) != -1) {
            browserName = "Safari";
            browserVersion = userAgent.substring(verOffset + 7);
            if ((verOffset = userAgent.indexOf("Version")) != -1)
                browserVersion = userAgent.substring(verOffset + 8);
        }
        // In Firefox, the true version is after "Firefox" 
        else if ((verOffset = userAgent.indexOf("Firefox")) != -1) {
            browserName = "Firefox";
            browserVersion = userAgent.substring(verOffset + 8);
        }
        // In most other browsers, "name/version" is at the end of userAgent 
        else if ((nameOffset = userAgent.lastIndexOf(' ') + 1) < (verOffset = userAgent.lastIndexOf('/'))) {
            browserName = userAgent.substring(nameOffset, verOffset);
            browserVersion = userAgent.substring(verOffset + 1);
            if (browserName.toLowerCase() == browserName.toUpperCase()) {
                browserName = navigator.appName;
            }
        }
        // Trim the browserVersion string at semicolon/space if present
        if ((ix = browserVersion.indexOf(";")) != -1)
            browserVersion = browserVersion.substring(0, ix);
        if ((ix = browserVersion.indexOf(" ")) != -1)
            browserVersion = browserVersion.substring(0, ix);

        majorVersion = parseInt('' + browserVersion, 10);
        if (isNaN(majorVersion)) {
            browserVersion = '' + parseFloat(navigator.appVersion);
            majorVersion = parseInt(navigator.appVersion, 10);
        }

        return {
			userAgent: userAgent,
            browserName: browserName,
            browserVersion: browserVersion
        };
    }

    // Fonction pour récupérer la localisation
    function getUserLocation() {
        return new Promise(function (resolve, reject) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                }, function (error) {
                    reject(error);
                });
            } else {
                reject(new Error('La géolocalisation n\'est pas supportée par votre navigateur.'));
            }
        });
    }

    // Récupérer les informations du navigateur
    var browserInfo = getBrowserInfo();

            // Gestionnaire d'événement pour le formulaire de soumission
            $('#formEv').submit(function (event) {
                event.preventDefault();

                // Récupérer les valeurs du formulaire
                var idDepartement = $('#departementSelect').val();
                var idSite = $('#siteSelect').val();
                var idEmploye = $('#employeSelect').val();
                var libelle = $('#libelle').val();
                var date = $('#dateEvenement').val();

			

				

				getUserLocation().then(function (location) {
					//data.localisation = location.longitude+","+location.latitude

					var coords = location.latitude + ',' + location.longitude;

					console.error('location:');
					console.error( location);


					var dataInterneNew={
                    idDepartement: idDepartement,
                    idSite: idSite,
                    idEmploye: idEmploye,
                    libelle: libelle,
                    dateEvenement: date,
					navigateur: browserInfo.browserName,
					deviceName: browserInfo.browserVersion,
					localisation:coords
				  }

				 // dataInterne = dataInterneNew;

				  console.error('dataInterne:');
				  console.error( dataInterne);

				  var formData = JSON.stringify({
					data:dataInterneNew
                });

				console.error('formData:');
					console.error( formData);

                // Soumettre les données via AJAX
                $.ajax({
                    url: 'http://217.76.50.150:3000/api/evenement/create',
                    method: 'POST',
					contentType: 'application/json',
                    data: formData,
                    success: function (response) {
                        if (!response.hasError) {
                            var successToast = new bootstrap.Toast($('#successToast'));
                            successToast.show();
                            setTimeout(function () {
                                window.location.href = 'index.html';
                            }, 3000);
                        } else {
                            $('#errorToast .toast-body').text(response.statut.message);
                            var errorToast = new bootstrap.Toast($('#errorToast'));
                            errorToast.show();
                        }
                    },
                    error: function (error) {
                        console.error('Erreur lors de l\'envoi des données:', error);
                        $('#errorToast .toast-body').text('Une erreur c\'est produite, Veuillez réessayer.');
                        var errorToast = new bootstrap.Toast($('#errorToast'));
                        errorToast.show();
                    }
                });

					//dataInterne.localisation = coords;
				}).catch(function (error) {
                    console.error('Erreur lors de la récupération de la localisation:', error);

					var dataInterne={
                    idDepartement: idDepartement,
                    idSite: idSite,
                    idEmploye: idEmploye,
                    libelle: libelle,
                    dateEvenement: date,
					navigateur: browserInfo.browserName,
					deviceName: browserInfo.userAgent,
				  }

				  var formData = JSON.stringify({
					data:dataInterne
                });

				console.error('formData:');
					console.error( formData);

                // Soumettre les données via AJAX
                $.ajax({
                    url: 'http://217.76.50.150:3000/api/evenement/create',
                    method: 'POST',
					contentType: 'application/json',
                    data: formData,
                    success: function (response) {
                        if (!response.hasError) {
                            var successToast = new bootstrap.Toast($('#successToast'));
                            successToast.show();
                            setTimeout(function () {
                                window.location.href = 'index.html';
                            }, 3000);
                        } else {
                            $('#errorToast .toast-body').text(response.statut.message);
                            var errorToast = new bootstrap.Toast($('#errorToast'));
                            errorToast.show();
                        }
                    },
                    error: function (error) {
                        console.error('Erreur lors de l\'envoi des données:', error);
                        $('#errorToast .toast-body').text('Une erreur c\'est produite, Veuillez réessayer.');
                        var errorToast = new bootstrap.Toast($('#errorToast'));
                        errorToast.show();
                    }
                });

                 });

	
            });
        });
    </script>
</head>
<body class="app">
    <div class="app-wrapper">
        <div class="app-content pt-3 p-md-3 p-lg-4">
            <div class="container-xl">
                <!-- Toasts -->
                <div aria-live="polite" aria-atomic="true" class="position-relative">
                    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3">
                        <!-- Toast for Success -->
                        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    Opération réalisée avec succès.
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                        <!-- Toast for Error -->
                        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    Une erreur s'est produite. Veuillez réessayer.
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <h1 class="app-page-title">FORMULAIRE D'ENREGISTREMENT D'EVENEMENT</h1>
                <div class="row g-4 settings-section">
                    <div class="col-12 col-md-8">
                        <div class="app-card app-card-settings shadow-sm p-4">
                            <div class="app-card-body">
                                <form class="settings-form" id="formEv" name="formEv">
                                    <div class="mb-3">
                                        <label for="employeSelect" class="form-label">Employé déclarant un incident</label>
                                        <select id="employeSelect" class="form-select" aria-label="Sélectionnez vos informations" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="siteSelect" class="form-label">Localisation/Site</label>
                                        <select id="siteSelect" class="form-select" aria-label="Sélectionnez votre site" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="departementSelect" class="form-label">Département</label>
                                        <select id="departementSelect" class="form-select" aria-label="Sélectionnez votre département" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="libelle" class="form-label">Description</label>
                                        <textarea name="libelle" id="libelle" class="form-control large-textarea" placeholder="Description" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="dateEvenement" class="form-label">Date de l'incident</label>
                                        <input type="datetime-local" class="form-control" id="dateEvenement" placeholder="date de l'incident" required>
                                    </div>
                                    <button type="submit" class="btn app-btn-primary">Soumettre</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <div class="container text-center py-3">
                <small class="copyright">Conçu avec <span class="sr-only">Amour</span><i class="fas fa-heart" style="color: #fb866a;"></i> par <a class="app-link" href="#" target="_blank">Le Groupe 3</a> Pour Le Groupe Eranove</small>
            </div>
        </footer>
    </div>

    <script src="assets/plugins/popper.min.js"></script>
    <script src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/app.js"></script>
</body>
</html>
